<html>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<style>

html, body{
  margin:0;
  padding:0;
  height:100%;
  background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAAoCAYAAAC7HLUcAAAFOElEQVR42u1aW4hVVRg2COyhCIsuUD6YRAWC0IuY0oOCRCio9BJBROiLYRLdURjmoVAYcBhmzlzPnKdAeomyyyRexoewhxBLyKJoAhnIUsNLKOlw/D75lyzXrH325ewZzvF8H/zss/daZ+21/vV///r/tfaCBYIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgdBQqlcoTw8PDhyH/Q+pDQ0N/Q56PlbXsINC5pZC/2MlQMJhLkK/xe0X4PzzvtToT7TBZY2NjD6CvJ2xsW1qpb9Vq9T706W3IKWcwdv0D0jM4OPjYHNvAOujmcsL8/wzZndQH6tLqnqCO3XPUfxjPfwra4zvWxcrakiDewC5A1qYRxDNCtrdUBEnH6OjoGvRnupH+jSwfzDdBArmCOu/X6/W7MhJkK57NQI6E5GpU1soEuc2oqQjcP+sx/dMcRthyBGlFwDiWQV+nzcCmcP/KwMDAvSzjFc82Q34wY+qda4KERg7yPoJnr9oqMmOyJ2Ob/ah7dWRkZFOesrYhSMRDTIgg5aGvr28hdLXfdHucYUesHh0ViYN6O+ebIH4fUPYhVzJcz6M/q9LapL24kCpPWdsRBMp4x1aQjxKI05u2TDvF0yPh/ksqmd7IynidxvVjxuIJS/+3uL4I+dEmiZ5sCvKS1VsBmWQYYO+cRr9fC8OB2MR4xjGB30/j+oVrx5LKHWE7RFdX192o86b1Y8beew7yCcb5TAYDWgn5N6vB+V69iA45vvHx8Ydwv88b3/4sBPEiin1hNOG3HwllQzsYTCprO4LQALjEm+JnebgiBMmQ73xGzxohyHXPCMPc6CuPGLMSwhwEuRRrh4RkzOy3U6vV7mFfY33KutqizW1W96g/5hJyxiQdch7Px/qZhSBBvV8RAj7aaQRJUvg/GNTLJEwjghQNsWhsjHPtPfSoKyMTQkP8DjHrc/Rk9IR4dsBT/C9MdtnHSqWyiB7WntdyEOTmO7gN6drB76o9/97lBtZOt61i/N+7HIOFIU+i7l562gwrSG+ov6LIo0M3vjwhViNnGhLkTg6x6iky6a8iZRHEU1oN//kP1xciE3cgDHOY4DHRgxwKJ5xtWFsTOQgy6x0gyVMWZv0Jgiz2xwi5xvCrqN7LJEhGHc7SkwjSZA5iocRGDOY3m8yRZglibW6xFWDaj6XDLdgk5Qehw23e3SZgOeRsOOFpOUj4jv7+/gfx/GRgEA1ztvkgSFk6FEFKSNIDb31LgUUIYtuaUykrVS6CxCbVjalZgsTGk9WY5ioHKVOHBQji6p2k8xBBglCD3gqx/pIiBLFtzYMuZ+D/2a6bEOdRW50gni6aXUHcLtYFtLM6x9ZwaTrMQxDLsaqRSEIEscMixtzHUef+NILQgDhxfhuM4RnLW+izPCnkaHWC+DkIV4Emz0EO5jkHKVuHRc5BuBHAA2QRxPbcaQQYzBnbtelulIMwF2BOYHX7/KQwSG67GUfbOx7H/S5vC7KlCRLsYnGbeXuRXSxrZ62tIO7sZltwkr7Bdp5unqSXrcM0XdpJ+q3TfDuDeiPpnKWjd7EwoM/dhCQRxDee2DlIrMwddLUTQexju8kGusr8ASfyu/Xh+UTsOyjIW0n6LarDyIZHo/m/GDs07XSCXLFdnNeznIN4Oyw9nmdkG9/QI5qX3WExvCs7xvONdgmxgnG+55+k27jG8+YmdsLdY1/v+l/znuLKwPIg3ClFh2kEscPT39k3vw8dRRBBEARBEARBEARBEARBEARBEARBEARBEARBEIQOww2fisGdguFPNAAAAABJRU5ErkJggg==');
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-position: right bottom; /*Positioning*/

  -webkit-user-select: none; /* webkit (safari, chrome) browsers */
}


.table-header-fix { overflow-y: auto; }
.table-header-fix-th { position: sticky; top: 0px;}
.table-header-fix-th2 { position: sticky; top: 139px; }

table { table-layout: fixed; border-collapse: collapse; width: 100%; }
td { width: 33%; }


#drop_zone {
  border: 10px dashed #bbb;
  -moz-border-radius: 50px;
  -webkit-border-radius: 50px;
  border-radius: 50px;
  padding: 10px;
  text-align: center;
  font: 40pt bold;
  color: #bbb;
}

a {
  font: 20pt bold;
}

.btn-group-sm>.btn, .btn-ssm {
    padding: .15rem .15rem;
    font-size: .777rem;
    line-height: 1.2;
    border-radius: .2rem;
}


</style>
<script>

var title = "";
var desc = "";
var gCarTrims = new Map();
var gAutoItems = new Map();
var gOnlyOneOptions = new Map();
var gRequiredOptions = new Map();
var secondFixed = false;

var nullClass = null;
var nullStyle = null;
var nullColspan = null;

function init(){
  
  if (window.File && window.FileReader && window.FileList && window.Blob) {

    var dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);

  } else {
    alert('지원하지 않는 브라우저입니다.');
  }

}

function addEvent(){

  $( ".opt-tr" ).on( "dblclick", function(){
    event.stopPropagation();

    var tr = $( ".opt-tr" );
    var td = $( ".opt-td" );
  
    if( secondFixed ){
      tr.removeClass( "table-primary" );
      td.removeClass( "table-header-fix-th2" );
      secondFixed = false;
    } else {
      tr.addClass( "table-primary" );
      td.addClass( "table-header-fix-th2" );
      secondFixed = true;
    }

  });

  $( ".btn-trim" ).on( "click", function(){
    event.stopPropagation();

    toggleTrim( $(this).attr('tid') );
  });

  $( ".btn-opt" ).on( "click", function(){
    event.stopPropagation();

    toggleOption( $(this).attr('tid'), $(this).attr('oid') );
  });

  toggleOption
}


function drawCarTrims(){

  var tbbuf = makeViews();

  document.getElementById('cartrims').innerHTML = tbbuf;

  addEvent();

}

function toggleTrim( trimId ){

  var trim = gCarTrims.get( trimId );

  var checked = trim.view;

  if( checked !=null && checked == "checked" ){
    trim.view = "";
  } else {
    trim.view = "checked"; 
  }

  drawCarTrims();
}


function toggleOption( trimId, optionId ){

  var error = false;
  var trim = gCarTrims.get( trimId );

  var checked = trim.checked.get( optionId );

  if( checked !=null && checked == "checked" ){
    trim.checked.set( optionId, "" );
  } else {
    trim.checked.set( optionId, "checked" ) 
  }
  
  //같이 선택할 수 없는 옵션 체크
  var cnt = 0;
  for (var [oid, checked] of trim.checked){
    
    if( gOnlyOneOptions.get(oid)!=null && checked == "checked" ){
      cnt++;
    }
  }

  //같이 선택할 수 없는 옵션 리스트 및 알림
  if( cnt>1 ){
    trim.checked.set( optionId, "" );

    var optList = '\n';
    for (var [oid, oidx] of gOnlyOneOptions){
      optList += '\n';
      optList += trim.options.get(oid).name;
    }

    alert( "알림:중복옵션" + optList );
    error = true;
  }

  //같이 선택되어야 하는 항목이 있는 지 체크
  if( !error ){
    for (var [oid, option] of trim.options){
      var joinVal = optionId + '@' + oid;
      var retVal = gRequiredOptions.get( joinVal );
      var checked = trim.checked.get( oid );

      if( retVal!=null && checked != 'checked' ){
        
        trim.checked.set( optionId, "" );

        var optList = '\n\n';
        optList += trim.options.get(optionId).name;
        optList += '\n';
        optList += "+ " + trim.options.get(oid).name;

        alert( "알림:필수옵션" + optList );
        error = true;
        break;
      }
    }
  }
  
  drawCarTrims();
}

function handleDragOver(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}


function handleFileSelect(evt) {
  evt.stopPropagation();
  evt.preventDefault();

  var files = evt.dataTransfer.files; // FileList object.

  for (var i = 0, f; f = files[i]; i++) {
    
    title = f.name;
    desc = "";
    
    var reader = new FileReader();

    // Closure to capture the file information.
    reader.onload = (function(theFile) {
      return function(e) {

        var text = e.target.result;
        var lines = text.split('\n');    // lines is an array of strings
        
        for (var j = 0; j < lines.length; j++) {

          var line = readLine( lines, j );

          if( line=='' ) continue;

          if( line.startsWith("//") ) continue; //주석

          if( line.startsWith("TITLE#") ){
            title = line.substring(6);
          }

          if( line.startsWith("DESC#") ){
            desc = line.substring(5);
          }

          if( line.startsWith("TRIM#") ){
            j = readCarTrim(lines,j, line);
            continue;
          }

          if( line.startsWith("OPT#") ){
            j = readCarTrim(lines,j, line);
            continue;
          }

          if( line.startsWith("PART#") ){
            j = readCarPart(lines,j, line);
            continue;
          }

          if( line.startsWith("&TRIM:") ){
            linkTrim( line );
            continue;
          }

          if( line.startsWith("&OPT#") ){
            uplinkTrim( line );
            continue;
          }

          if( line.startsWith("&ON:") ){
            autoItem( line );
            continue;
          }

          if( line.startsWith("&ONLY:")){
            onlyOneOption(line);
          }

          if( line.startsWith("&REQUIRED:")){
            requiredOption(line);
          }

        }

        console.log( "ALL TRIMS" );
        console.log( gCarTrims );
        console.log( gAutoItems );

        drawCarTrims();
      };
    })(f);

    reader.readAsText(f);
  }
}


function readCarPart(lines, idx, id){

  var cartrim = Array.from(gCarTrims.values()).pop();
  var part = cartrim.parts.get(id);
  var n=0;
  
  if( part==null ){
    part = new Object();
    part.id = id;
    part.name = id.substring(5);
    part.items = new Map();
  }

  idx++;
  
  for (; idx < lines.length; idx++) {
    
    var line = readLine( lines, idx );
    if( line=='' ) break;
    
    var desc = "";
    var item = new Object();
    if( line.startsWith("*") ){
      var pos = line.indexOf( ":" );
      item.id = line.substring( 1, pos ).trim();
      item.name = line.substring( pos+1 ).trim();
      desc = item.id + ": " + item.name;
    } else {
      item.id = line;
      item.name = line;
      desc = line;
    }

    part.items.set( item.id, item );

    n++;
  }

  cartrim.parts.set( part.id, part );
  return idx;
}


function readCarTrim(lines, idx, id){

  var cartrim = new Object();

  cartrim.id = id;
  idx++;
  cartrim.category = readLine( lines, idx);
  idx++;
  cartrim.name = readLine( lines, idx);
  idx++;
  var strPrice = readLine( lines, idx);
  cartrim.price = parseFloat( strPrice.replace(/,/g, '') ) ;
  idx++;
  cartrim.parts = new Map();
  cartrim.options = new Map();
  cartrim.checked = new Map();
  cartrim.view = "checked";

  gCarTrims.set( cartrim.id, cartrim );

  return idx;
}

function linkTrim(id){

  if( id.startsWith("&TRIM:") ) id = id.substring(6);

  var linkCartrim = gCarTrims.get(id);
  var currentCartrim = Array.from(gCarTrims.values()).pop();

  copyParts( linkCartrim, currentCartrim );
}

function uplinkTrim(id){
  
  var pos = id.indexOf(":");
  if( !id.startsWith("&") || pos < 0 ) return;

  var optionId = id.substring(1,pos);
  var trimId = id.substring(pos+1);
  var option = gCarTrims.get(optionId);
  var trim = gCarTrims.get(trimId);
  
  if( option==null ){
    alert( "Not found trim - " + optionId );
  }

  if( trim==null ){
    alert( "Not found trim - " + trimId );
  }

  trim.options.set( optionId, option );
}


function autoItem(id){
  id = id.substring(4); //&ON:
  var pos = id.indexOf(":");
  
  var iid = id.substring( 0, pos ).trim();
  id = id.substring( pos+1 ).trim();

  gAutoItems.set( iid, id );
}

function onlyOneOption(id){
  id = id.substring(6) //&ONLY:

  var opts = id.split('|');
  
  for ( var oi in opts ) {

    var opt = opts[oi].trim();

    gOnlyOneOptions.set( opt, opt );
  }
}

function requiredOption(id){
  id = id.substring(10) //&REQUIRED:

  var opts = id.split('|');
  
  for ( var oi in opts ) {

    var opt = opts[oi].trim();

    gRequiredOptions.set( opt, opt );
  }

  console.log( "gRequiredOptions" );
  console.log( gRequiredOptions );
}



function copyParts(from, to) {
  
  for (var [fromPartId, fromPart] of from.parts) {
    
    var toPart = new Object();
    toPart.id = fromPart.id;
    toPart.name = fromPart.name;
    toPart.items = new Map();

    for (var [fromItemId, fromItem] of fromPart.items) {
      
      var toItem = new Object();
      toItem.id = fromItemId;
      toItem.name = fromItem.name;
      toPart.items.set( toItem.id, toItem );
    }
    
    to.parts.set( toPart.id, toPart );
  }
}

function itemSummary( optionId ){

  var summary = "";

  var cartrim = gCarTrims.get( optionId );

  summary += cartrim.name;
  summary += "\n";
  summary += "--------------------------------------------------";

  for (var [pid, part] of cartrim.parts){

    for (var [iid, item] of part.items) {

      summary += "\n";
      
      if( item.id == item.name ){
        summary += item.id;
      } else {
        summary += item.id + " : " + item.name;
      }
    }
  }

  return summary;
}

function makeViews(){

  //파트별 전체앙
  var tParts = new Map();
  for (var [tid, cartrim] of gCarTrims){
    for (var [pid, part] of cartrim.parts){
      var tPart = tParts.get( pid );
       
      if( tPart==null ){
        tPart = new Object();
        tPart.id = part.id;
        tPart.name = part.name;
        tPart.items = new Map();
        tParts.set( tPart.id, tPart );
      }
      
      for (var [iid, item] of part.items){
        var tItem = new Object();
        tItem.id = item.id;
        tPart.items.set( tItem.id, tItem );
      }
    }
  }
  
  var tbbuf = "";
  var trimCnts = 0;

  //견적테이블
  tbbuf += otable( "table table-hover table-header-fix" );;
  tbbuf += oth();
  
  //트림목록
  tbbuf += otr( "table-primary", desc );
  tbbuf += mktd( trimHeader( title ), "table-header-fix-th", "font-weight: bold; font-size: 18px;" );
  for (var [tid, cartrim] of gCarTrims){
    if( !tid.startsWith("TRIM#") || cartrim.view != "checked" ) continue;

    var carPrice = cartrim.price;
    var optionTotal = 0;

    for (var [optionId, option] of cartrim.options){
      var checked = cartrim.checked.get( optionId );
      if( checked == "checked" ) optionTotal += option.price; //선택된 옵션 가격 더함
    }

    var tax = ( carPrice + optionTotal ) * 0.07;
    var totalPrice = carPrice + optionTotal + tax;
    var priceList = "";
	  priceList += price( '', carPrice, "btn btn-secondary btn-ssm" );
    priceList += price( '+ ', optionTotal, "btn btn-secondary btn-ssm" );
	  priceList += price( '+ ', tax, "btn btn-secondary btn-ssm", null, '7%'  );
	  priceList += price( '= ', totalPrice, "btn btn-danger btn-ssm", 'white' );
	
    tbbuf += mktd( trimHeader( cartrim.category, cartrim.name, priceList ), "table-header-fix-th", "font-size: 14px; font-weight: bold;" );

  }
  tbbuf += ctr();

  //트림별 선택가능한 옵션목록
  var clsSecondFixed = "";
  var clsSecondPrimary = "";
  
  if( secondFixed ){
	clsSecondFixed = " table-header-fix-th2";
	clsSecondPrimary = " table-primary";
  }

  tbbuf += otr( "opt-tr" + clsSecondPrimary, "double click to fix / release" );
  
  var trimlist = "";
  for (var [tid, cartrim] of gCarTrims){
    if( !tid.startsWith("TRIM#") ) continue;

    var checked = cartrim.view;
    trimlist += toggleTrimButton( cartrim.id, checked, cartrim.category + nbsp() + cartrim.name );
  }

  tbbuf += mktd( trimlist, "opt-td" + clsSecondFixed, "font-size: 14px;" );

  for (var [tid, cartrim] of gCarTrims){
    if( !tid.startsWith("TRIM#") || cartrim.view != "checked" ) continue;
    trimCnts++;

    var optionlist = "";
    for (var [optionId, option] of cartrim.options){
      var checked = cartrim.checked.get( optionId );
      var summary = itemSummary( optionId );
      optionlist += toggleOptionButton( cartrim.id, optionId, checked, option.name, summary, option.price );
    }
    
    tbbuf += mktd( optionlist, "opt-td" + clsSecondFixed, "font-size: 14px;" );
  }
  tbbuf += ctr();
  tbbuf += cth();

  //사양리스트
  tbbuf += ctb();
  for (var [pid, part] of tParts){

    //사양분류
    tbbuf += otr( "table-secondary" );
    tbbuf += mktd( part.name, "part-dt text-center", "font-weight: bold;", (trimCnts+1) );
    tbbuf += ctr();

    for (var [iid, item] of part.items){

      //사양명
      tbbuf += otr();
      tbbuf += mktd( item.id );

      for (var [tid, cartrim] of gCarTrims){
        if( !tid.startsWith("TRIM#") || cartrim.view != "checked" ) continue;

        //지원, 선택여부
        var ox = "X";

        //옵션에서 선택한 경우
        for (var [optionsId, option] of cartrim.options){
          if( cartrim.checked.get(optionsId) != "checked" ) continue;
          var trimPart = option.parts.get(pid);
          if( trimPart!=null ){
            var trimItem = trimPart.items.get(iid);
            if( trimItem!=null){
              if( trimItem.id != trimItem.name ){
                ox = "+" + option.name + br() + trimItem.name;
              } else {
                ox = "+" + option.name;
              }
            }
          }
        }//--옵션 선적용

        //기본 품목 적용
        if( ox == "X" ){
          var trimPart = cartrim.parts.get(pid);
          if( trimPart!=null ){
            var trimItem = trimPart.items.get(iid);
            if( trimItem!=null){
              if( trimItem.id == trimItem.name ){
                ox = "O";
              } else {
                ox = trimItem.name;
              }
            }
          }
        }//--기본 품목 적용
        
        //옵션, 기본 모두 선택되지 않은 경우 선택한 옵션에 따라 자동활성화 되는 기능 체크
        if( ox == "X" ){
          var expstr = gAutoItems.get( iid );
          if( expstr!=null ){
            console.log( "AUTOITEM " + tid + "/" + iid + ", " + expstr );
            console.log( cartrim.checked ); //옵션맵

            var expSplit = expstr.split('|');
            for ( var ri in expSplit ) {
              expstr = expSplit[ri].trim();
              console.log( "AUTOITEM[" + ri + "] " + tid + "/" + iid + ", " + expstr );
              var refOptionIds = expstr.split('&');

              ox = "";
              for ( var si in refOptionIds ) {
                var rOid = refOptionIds[si].trim();
                var checked = cartrim.checked.get( rOid );
                console.log( rOid + " = " + checked );

                if(  checked != "checked" ){
                  ox = "X";
                  break;
                } else {
                  if( si>0 ) ox = ox + br();
                  ox = ox + "+" + gCarTrims.get( rOid ).name;
                  console.log( ox );
                }
              }
              
              if( ox != "X" ) break;
            }

          }
        }

        tbbuf += mktd( ox, nullClass, "font-size: 14px;" );
      }

      tbbuf += ctr();
    }

  }

  tbbuf += ctb();
  tbbuf += ctable();

  return tbbuf;
}

</script>

<body onload="javascript:init();">

  <div id="cartrims" style="width: 100%; height: 100%;">
    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; ">
      <div id="drop_zone" style="width: 70%; height: 60%;">
        <div>
          <br>
          *.trims file here.
          <br>
          <br>
          Bitaminc CarDiff
          <br>
          <a href="https://github.com/Bitaminc">GitHub</a>
          <br>
          <br>
          <span style="font-size: 20px;">Browser Support: </span><span style="font-size: 20px; color: red;">Chrome</span>
        </div>
      </div>
    </div>
  </div>
  
</body>
</html>


<script>


function readLine(lines, idx){
  return lines[idx].trim();
}

function strtrim(str){
  return str.replace(/^\s+|\s+$/g,"");
}


//-----------------------------------------------
//-- TABLE TD 생성
//-----------------------------------------------

function mktd( value, clazz, style, colspan ){

	var tdbuf = '<td';

	if( clazz!=null ) tdbuf += ' class="' + clazz + '"';
	if( style!=null ) tdbuf += ' style="' + style + '"';
	if( colspan!=null ) tdbuf += ' colspan="' + colspan + '"';

	tdbuf += '>';
	tdbuf += value;
	tdbuf += '</td>';

	return tdbuf;
}

function otable( clazz ){
  return '<table class="' + clazz + '">';
}

function ctable(){
  return '</table>';
}

function otr( clazz, title ){
  var trbuf = "";
  
  trbuf += '<tr';
  if( clazz!=null ) trbuf +=  ' class="' + clazz + '"';
  if( title!=null ) trbuf += ' title="' + title + '"';
  trbuf += '>';
  
  return trbuf;
}

function ctr( clazz ){
  return '</tr>';
}

function oth(){
  return '<thead>';
}

function cth(){
  return '</thead>';
}

function otb(){
  return '<tbody>';
}

function ctb(){
  return '</tbody>';
}

function br(){
  return '<br>';
}

function nbsp( n ){

  if( n==null ) return '&nbsp;';
  
  var nbspbuf = "";
  
  for(var i=0;i<n;i++) nbspbuf += "&nbsp;";
  
  return nbspbuf;
}

function sp( value, title ){

  return '<span title="' + title + '">' + value + '</span>';
}

function trimHeader( category, name, priceList ){

  var htmlbuf = "";

  htmlbuf += ellipsis( category );
  if( name!=null ) htmlbuf += ellipsis( name );
  if( priceList!=null ) htmlbuf += priceList;
  
  return htmlbuf;
}



function price( flag, price, clazz, color, extra ){

  var intVal = Math.round(price);
  var formatted = intVal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  var htmlbuf = "";
  
  htmlbuf += '<button type="button"';
  if( clazz!=null ) htmlbuf += ' class="' + clazz + '"';
  htmlbuf += ' style="height: 19px; width:100%; text-align: left;';
  if( color!=null ) htmlbuf += ' font-weight: bold; color: ' + color + ';';
  htmlbuf += '"';
  htmlbuf += ' title="' + formatted + '"';
  htmlbuf += ' disabled>';
  if( extra!=null ) htmlbuf += ellipsis( flag + formatted + ' (' + extra + ')' );
  else htmlbuf += ellipsis( flag + formatted );
  htmlbuf += '</button>'

  return htmlbuf;
}

function ellipsis( text, bgColor, fontWeight, fontColor ){
  
  var htmlbuf = "";
  
  htmlbuf += '<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
  if( bgColor!=null  )  htmlbuf += ' background-color: ' + bgColor + ';';
  if( fontWeight!=null  )  htmlbuf += ' font-weight: ' + fontWeight + ';';
  if( fontColor!=null  )  htmlbuf += ' color: ' + fontColor + ';';
  htmlbuf += '">';
  htmlbuf += text;
  htmlbuf += '</div>';
 
  return htmlbuf;
}

function toggleTrimButton( trimId, checked, name ){

  var htmlbuf = "";
  var formatted = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  var selected = "btn-secondary";

  if( checked!=null && checked == "checked" ) selected = "btn-primary";

  htmlbuf += '<button type="button" class="btn-trim btn ' + selected + ' btn-ssm mb-1" style="height: 19px; width:100%; text-align: left;"';
  htmlbuf += ' tid="' + trimId + '"';
  htmlbuf += ' title="' + name + '"';
  htmlbuf += '>';
  htmlbuf += ellipsis( name );
  htmlbuf += '</button>'

  return htmlbuf;
}


function toggleOptionButton( trimId, optionId, checked, name, summary, price ){

  var htmlbuf = "";
  var formatted = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  var selected = "btn-secondary";

  if( checked!=null && checked == "checked" ) selected = "btn-primary";

  var textbuf = "";
  textbuf += '<span style="border-radius: 2px; color: #FFC107; font-weight: bold;">' + formatted + '</span>';
  textbuf += nbsp();
  textbuf += name;
  
  htmlbuf += '<button type="button" class="btn-opt btn ' + selected + ' btn-ssm mb-1" style="height: 19px; width:100%; text-align: left;"';
  htmlbuf += ' tid="' + trimId + '"';
  htmlbuf += ' oid="' + optionId + '"';
  htmlbuf += ' title="' + summary + '"';
  htmlbuf += '>';
  htmlbuf += ellipsis( textbuf );
  htmlbuf += '</button>'

  return htmlbuf;
}




</script>